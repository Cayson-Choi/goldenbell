generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           Int       @id @default(autoincrement())
  name         String    @unique
  passwordHash String
  createdAt    DateTime  @default(now())
  attempts     Attempt[]
  dailyPlans   DailyPlan[]
  dailyPlanQuestions DailyPlanQuestion[]
  badges       UserBadge[]
  stats        UserStats?
}

model Question {
  id             Int       @id @default(autoincrement())
  course         String
  month          Int
  topic          String
  difficulty     String
  questionNumber Int
  questionText   String
  answer         String
  attempts       Attempt[]
  dailyQuestions DailyPlanQuestion[]

  @@index([course, month])
  @@index([difficulty])
}

model Attempt {
  id         Int      @id @default(autoincrement())
  userId     Int
  questionId Int
  user       User     @relation(fields: [userId], references: [id])
  question   Question @relation(fields: [questionId], references: [id])
  userAnswer String
  isCorrect  Boolean
  points     Int      @default(0)
  createdAt  DateTime @default(now())

  @@index([userId, questionId])
  @@index([userId, isCorrect])
}

model DailyPlan {
  id        Int      @id @default(autoincrement())
  userId    Int
  dayNumber Int
  date      DateTime
  completed Boolean  @default(false)
  user      User     @relation(fields: [userId], references: [id])
  questions DailyPlanQuestion[]

  @@unique([userId, dayNumber])
}

model DailyPlanQuestion {
  id         Int       @id @default(autoincrement())
  userId     Int
  dayNumber  Int
  questionId Int
  solved     Boolean   @default(false)
  user       User      @relation(fields: [userId], references: [id])
  dailyPlan  DailyPlan @relation(fields: [userId, dayNumber], references: [userId, dayNumber])
  question   Question  @relation(fields: [questionId], references: [id])

  @@unique([userId, dayNumber, questionId])
  @@index([userId, dayNumber])
}

model UserBadge {
  id       Int       @id @default(autoincrement())
  userId   Int
  badgeKey String
  name     String
  description String @default("")
  earnedAt DateTime?
  user     User      @relation(fields: [userId], references: [id])

  @@unique([userId, badgeKey])
}

model UserStats {
  id              Int       @id @default(autoincrement())
  userId          Int       @unique
  totalPoints     Int       @default(0)
  currentCombo    Int       @default(0)
  maxCombo        Int       @default(0)
  consecutiveDays Int       @default(0)
  lastStudyDate   DateTime?
  planStartDate   DateTime?
  user            User      @relation(fields: [userId], references: [id])
}
